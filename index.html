<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Ghost Exchange - Economy Update</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0b0c0f; --panel: #16171d; --accent: #bb86fc; --text: #e1e1e1; --gold: #ffd700; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        .header { height: 60px; background: var(--panel); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #333; justify-content: space-between; position: relative; z-index: 10001; }
        .stats { display: flex; gap: 20px; align-items: center; }
        .coin-balance { color: var(--gold); font-weight: bold; }

        .wrapper { display: grid; grid-template-columns: 220px 1fr 300px; height: calc(100vh - 60px); }
        .feed { padding: 20px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 20px; }
        
        .item-card { background: var(--panel); width: 230px; border-radius: 12px; border: 1px solid #333; overflow: hidden; position: relative; }
        .price-tag { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; color: var(--gold); font-size: 12px; }
        .item-img { width: 100%; height: 130px; object-fit: cover; background: #222; }
        
        #admin-panel { display: none; position: fixed; top: 70px; left: 5%; width: 90%; height: 80%; background: #111; z-index: 20000; border: 2px solid var(--accent); padding: 20px; overflow-y: auto; border-radius: 15px; }
        .promo-section { background: #1a1b21; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px dashed var(--accent); }

        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; background: #25262b; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        button { padding: 10px; background: var(--accent); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        .error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; text-align: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="reg-screen" style="position:fixed; width:100%; height:100%; background:var(--bg); z-index:30000; display:flex; align-items:center; justify-content:center;">
        <div style="background:var(--panel); padding:30px; border-radius:15px; text-align:center; width:300px; border:1px solid #444;">
            <h2>–í—Ö—ñ–¥</h2>
            <input type="text" id="user-login" placeholder="–ù—ñ–∫–Ω–µ–π–º">
            <button onclick="startSession()" style="width:100%; margin-top:10px;">–£–í–Ü–ô–¢–ò</button>
        </div>
    </div>

    <div class="header">
        <div class="stats">
            <span style="color:var(--accent); font-weight:bold;">GHOST SYSTEM</span>
            <span class="coin-balance">üí∞ <span id="balance-val">0</span> Coins</span>
            <button onclick="usePromo()" style="padding:5px 10px; font-size:12px;">–ü–†–û–ú–û–ö–û–î</button>
        </div>
        <div style="width:30px; height:30px; background:#333; border-radius:50%; cursor:pointer;" onclick="openAdmin()"></div>
    </div>

    <div class="wrapper" id="main-wrapper">
        <div class="side-panel" style="padding:15px; border-right:1px solid #333;">
            <h4>–î—Ä—É–∑—ñ</h4>
            <div id="friends-list"></div>
        </div>
        <div class="feed" id="main-feed"></div>
        <div class="chat-panel" style="background:var(--panel); border-left:1px solid #333; display:flex; flex-direction:column;">
            <div id="chat-box" style="flex:1; padding:15px; overflow-y:auto; font-size: 14px;"></div>
            <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–∏ (+10üí∞)..." style="border:none; border-top:1px solid #333; padding:15px;" onkeypress="sendChat(event)">
        </div>
    </div>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between;"><h2>–ê–¥–º—ñ–Ω–∫–∞</h2><button onclick="this.parentElement.parentElement.style.display='none'">X</button></div>
        
        <div class="promo-section">
            <h3>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ü—Ä–æ–º–æ–∫–æ–¥</h3>
            <input type="text" id="p-code" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä: GHOST2024)">
            <select id="p-type">
                <option value="coins">–î–∞—Ç–∏ 500 –º–æ–Ω–µ—Ç</option>
                <option value="discount">–ó–Ω–∏–∂–∫–∞ –Ω–∞ —Ç—Ä–µ–π–¥</option>
                <option value="free">–ë–µ–∑–ø–ª–∞—Ç–Ω–∏–π —Ç—Ä–µ–π–¥</option>
            </select>
            <button onclick="createPromo()">–î–û–î–ê–¢–ò –ü–†–û–ú–û</button>
            <div id="active-promos" style="margin-top:10px; font-size:12px; color:#888;"></div>
        </div>

        <div id="admin-list" style="margin-top:20px;"></div>
    </div>

    <div id="addModal" class="error-overlay" style="background:rgba(0,0,0,0.8); z-index:15000;">
        <div style="background:var(--panel); padding:25px; border-radius:15px; width:350px; text-align:left;">
            <h3>–ù–æ–≤–∏–π –ø–æ—Å—Ç</h3>
            <input type="text" id="f-title" placeholder="–ù–∞–∑–≤–∞">
            <input type="text" id="f-img" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏">
            <input type="text" id="f-price" placeholder="–¶—ñ–Ω–∞ (–Ω–∞–ø—Ä: 500 Coins)">
            <textarea id="f-desc" placeholder="–û–ø–∏—Å"></textarea>
            <button onclick="publish()" style="width:100%;">–û–ü–£–ë–õ–Ü–ö–£–í–ê–¢–ò</button>
            <button onclick="document.getElementById('addModal').style.display='none'" style="background:none; color:grey; margin-top:10px;">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <div id="errScr" class="error-overlay">
        <img src="image_7cdb7b.png" style="width:150px;">
        <h1>–ü–æ–º–∏–ª–∫–∞ 999</h1>
        <p>–í–∞—Å –∑–∞–±–∞–Ω–µ–Ω–æ.</p>
    </div>

    <button id="add-btn" style="position:fixed; bottom:20px; right:320px; width:60px; height:60px; border-radius:50%; background:var(--accent); border:none; font-size:30px; cursor:pointer;" onclick="document.getElementById('addModal').style.display='flex'">+</button>

    <script>
        const firebaseConfig = { databaseURL: "https://book-main-1fc44-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myNick = localStorage.getItem('ghost_user') || "";
        let myCoins = 0;

        // 1. –ï–ö–û–ù–û–ú–Ü–ö–ê –¢–ê –ë–ê–ù
        function syncData(nick) {
            // –°–ª—É—Ö–∞—î–º–æ –º–æ–Ω–µ—Ç–∏
            db.ref('users').child(nick).child('coins').on('value', s => {
                myCoins = s.val() || 0;
                document.getElementById('balance-val').innerText = myCoins;
            });
            // –°–ª—É—Ö–∞—î–º–æ –±–∞–Ω
            db.ref('banned').child(nick).on('value', s => {
                const isBanned = s.exists();
                document.getElementById('errScr').style.display = isBanned ? 'flex' : 'none';
                document.getElementById('main-wrapper').style.display = isBanned ? 'none' : 'grid';
                if(isBanned) document.getElementById('reg-screen').style.display = 'none';
            });
        }

        function startSession() {
            const n = document.getElementById('user-login').value.trim();
            if(n.length < 2) return;
            myNick = n;
            localStorage.setItem('ghost_user', n);
            document.getElementById('reg-screen').style.display = 'none';
            syncData(n);
        }
        if(myNick) { syncData(myNick); document.getElementById('reg-screen').style.display = 'none'; }

        // 2. –ß–ê–¢ (–ù–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –≤–∞–ª—é—Ç–∏)
        function sendChat(e) {
            if(e.key === 'Enter' && e.target.value.trim() !== "") {
                db.ref('chat').push({ user: myNick, text: e.target.value });
                // –î–∞—î–º–æ +10 –º–æ–Ω–µ—Ç –∑–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                db.ref('users').child(myNick).child('coins').set(myCoins + 10);
                e.target.value = "";
            }
        }

        // 3. –ü–†–û–ú–û–ö–û–î–ò
        function createPromo() {
            const code = document.getElementById('p-code').value.toUpperCase();
            const type = document.getElementById('p-type').value;
            if(!code) return;
            db.ref('promos').child(code).set({ type: type, active: true });
            alert("–ü—Ä–æ–º–æ–∫–æ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–æ!");
        }

        function usePromo() {
            const code = prompt("–í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥:").toUpperCase();
            db.ref('promos').child(code).once('value', s => {
                if(s.exists() && s.val().active) {
                    const data = s.val();
                    if(data.type === 'coins') {
                        db.ref('users').child(myNick).child('coins').set(myCoins + 500);
                        alert("–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 500 –º–æ–Ω–µ—Ç!");
                    } else if(data.type === 'discount') {
                        alert("–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ: –ó–Ω–∏–∂–∫–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ç—Ä–µ–π–¥!");
                    } else if(data.type === 'free') {
                        alert("–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ: –ë–µ–∑–ø–ª–∞—Ç–Ω–∏–π —Ç—Ä–µ–π–¥ –¥–æ—Å—Ç—É–ø–Ω–∏–π!");
                    }
                    // –í–∏–º–∏–∫–∞—î–º–æ –ø—Ä–æ–º–æ–∫–æ–¥ –ø—ñ—Å–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è (—è–∫—â–æ —Ç—Ä–µ–±–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∏–π)
                    // db.ref('promos').child(code).remove(); 
                } else {
                    alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∫–æ–¥.");
                }
            });
        }

        // 4. –ü–£–ë–õ–Ü–ö–ê–¶–Ü–á –¢–ê –ê–î–ú–Ü–ù–ö–ê
        db.ref('posts').on('value', snapshot => {
            const feed = document.getElementById('main-feed');
            const alist = document.getElementById('admin-list');
            feed.innerHTML = ""; alist.innerHTML = "<h3>–ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ—Å—Ç–∞–º–∏:</h3>";
            snapshot.forEach(child => {
                const d = child.val();
                feed.innerHTML += `
                    <div class="item-card">
                        <div class="price-tag">${d.price || 'Offer'}</div>
                        <img src="${d.img || ''}" class="item-img" onerror="this.src='https://via.placeholder.com/230x130?text=No+Image'">
                        <div class="item-info">
                            <b>${d.title}</b><br>
                            <small style="color:#888;">${d.desc || ''}</small><br>
                            <span style="color:var(--accent); font-size:12px;">@${d.nick}</span>
                        </div>
                    </div>`;
                alist.innerHTML += `<div style="background:#222; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between;">
                    <span>${d.title} (@${d.nick})</span>
                    <button onclick="db.ref('posts').child('${child.key}').remove()" style="background:red;">DEL</button>
                    <button onclick="db.ref('banned').child('${d.nick}').set(true)" style="background:orange;">BAN</button>
                </div>`;
            });
        });

        function publish() {
            db.ref('posts').push({
                nick: myNick,
                title: document.getElementById('f-title').value,
                img: document.getElementById('f-img').value,
                price: document.getElementById('f-price').value,
                desc: document.getElementById('f-desc').value
            });
            document.getElementById('addModal').style.display = 'none';
        }

        function openAdmin() {
            if(prompt("–ü–∞—Ä–æ–ª—å:") === "loldemid509") document.getElementById('admin-panel').style.display = 'block';
        }

        db.ref('chat').limitToLast(20).on('child_added', s => {
            const cb = document.getElementById('chat-box');
            cb.innerHTML += `<div><b>${s.val().user}:</b> ${s.val().text}</div>`;
            cb.scrollTop = cb.scrollHeight;
        });

        // –í–∏–≤—ñ–¥ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø—Ä–æ–º–æ –≤ –∞–¥–º—ñ–Ω—Ü—ñ
        db.ref('promos').on('value', s => {
            const div = document.getElementById('active-promos');
            div.innerHTML = "–ê–∫—Ç–∏–≤–Ω—ñ –∫–æ–¥–∏: ";
            s.forEach(p => { div.innerHTML += p.key + " (" + p.val().type + "), "; });
        });
    </script>
</body>
</html>
