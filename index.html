<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Ghost Market - Economy Fix</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0b0c0f; --panel: #16171d; --accent: #bb86fc; --text: #e1e1e1; --gold: #ffd700; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        .header { height: 60px; background: var(--panel); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #333; justify-content: space-between; position: relative; z-index: 10001; }
        .coin-balance { color: var(--gold); font-weight: bold; background: #25262b; padding: 5px 15px; border-radius: 20px; border: 1px solid #444; }

        .wrapper { display: grid; grid-template-columns: 220px 1fr 300px; height: calc(100vh - 60px); }
        .feed { padding: 20px; overflow-y: auto; display: flex; flex-wrap: wrap; gap: 20px; align-content: flex-start; }
        
        .item-card { background: var(--panel); width: 230px; border-radius: 12px; border: 1px solid #333; overflow: hidden; position: relative; transition: 0.3s; min-height: 250px; display: flex; flex-direction: column; }
        .price-tag { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 6px; color: var(--gold); font-size: 12px; font-weight: bold; z-index: 10; border: 1px solid var(--gold); }
        .item-img { width: 100%; height: 130px; object-fit: cover; background: #222; }
        .item-info { padding: 12px; flex-grow: 1; }

        /* –ó–∞–º–æ—á–æ–∫ —Ç–∞ —Ä–æ–∑–º–∏—Ç—Ç—è */
        .locked-blur { filter: blur(5px); opacity: 0.6; user-select: none; pointer-events: none; }
        .buy-btn-container { padding: 10px; background: rgba(0,0,0,0.3); border-top: 1px solid #333; text-align: center; }
        .btn-buy { width: 100%; background: var(--gold); color: black; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-buy:hover { background: #e6c200; transform: scale(1.02); }

        #admin-panel { display: none; position: fixed; top: 70px; left: 5%; width: 90%; height: 80%; background: #111; z-index: 20000; border: 2px solid var(--accent); padding: 20px; overflow-y: auto; border-radius: 15px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; background: #25262b; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        button { padding: 10px; background: var(--accent); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; text-align: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="reg-screen" style="position:fixed; width:100%; height:100%; background:var(--bg); z-index:30000; display:flex; align-items:center; justify-content:center;">
        <div style="background:var(--panel); padding:30px; border-radius:15px; text-align:center; width:300px; border: 1px solid #444;">
            <h2 style="color:var(--accent);">Ghost Market</h2>
            <input type="text" id="user-login" placeholder="–í–∞—à –Ω—ñ–∫–Ω–µ–π–º">
            <button onclick="startSession()" style="width:100%; margin-top:10px;">–ü–û–ß–ê–¢–ò</button>
        </div>
    </div>

    <div class="header">
        <div style="display:flex; gap:15px; align-items:center;">
            <b>GHOST SYSTEM</b>
            <div class="coin-balance">üí∞ <span id="balance-val">0</span></div>
            <button onclick="usePromo()" style="background:#333; color:white; padding:5px 10px; font-size:11px;">–ü–†–û–ú–û–ö–û–î</button>
        </div>
        <div style="width:30px; height:30px; background:#444; border-radius:50%; cursor:pointer;" onclick="openAdmin()"></div>
    </div>

    <div class="wrapper" id="main-wrapper">
        <div class="side" style="padding:15px; border-right:1px solid #333;">
            <h4>–ö—É–ø–ª–µ–Ω—ñ —Ä–µ—á—ñ</h4>
            <div id="my-items" style="font-size:12px; color:#888;"></div>
        </div>
        <div class="feed" id="main-feed"></div>
        <div class="chat" style="background:var(--panel); display:flex; flex-direction:column; border-left:1px solid #333;">
            <div id="chat-box" style="flex:1; padding:15px; overflow-y:auto;"></div>
            <input type="text" id="chat-input" placeholder="–ß–∞—Ç (+10üí∞)..." onkeypress="sendChat(event)" style="border-radius:0; border:none; border-top:1px solid #333; padding:15px; background:#1a1b21; color:white;">
        </div>
    </div>

    <div id="addModal" class="error-overlay" style="background:rgba(0,0,0,0.8); z-index:15000;">
        <div style="background:var(--panel); padding:25px; border-radius:15px; width:350px;">
            <h3>–ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä</h3>
            <input type="text" id="f-title" placeholder="–ù–∞–∑–≤–∞">
            <input type="text" id="f-img" placeholder="URL –∫–∞—Ä—Ç–∏–Ω–∫–∏">
            <input type="number" id="f-price" placeholder="–¶—ñ–Ω–∞ (—Ü–∏—Ñ—Ä–∏)">
            <textarea id="f-desc" placeholder="–°–µ–∫—Ä–µ—Ç–Ω–∏–π –æ–ø–∏—Å (–±—É–¥–µ –≤–∏–¥–Ω–æ –ø—ñ—Å–ª—è –ø–æ–∫—É–ø–∫–∏)"></textarea>
            <button onclick="publish()" style="width:100%;">–í–ò–°–¢–ê–í–ò–¢–ò</button>
            <button onclick="document.getElementById('addModal').style.display='none'" style="background:none; color:grey;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between;"><h2>–ê–¥–º—ñ–Ω–∫–∞</h2><button onclick="this.parentElement.parentElement.style.display='none'">X</button></div>
        <input type="text" id="p-code" placeholder="–ö–æ–¥"><input type="number" id="p-amount" placeholder="–°—É–º–∞"><button onclick="createPromo()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ–º–æ</button>
        <div id="admin-list" style="margin-top:20px;"></div>
    </div>

    <div id="errScr" class="error-overlay"><h1>üîí BAN</h1></div>
    <button style="position:fixed; bottom:20px; right:320px; width:60px; height:60px; border-radius:50%; background:var(--accent); border:none; font-size:30px; cursor:pointer;" onclick="document.getElementById('addModal').style.display='flex'">+</button>

    <script>
        const firebaseConfig = { databaseURL: "https://book-main-1fc44-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let myNick = localStorage.getItem('ghost_user') || "";
        let myCoins = 0;

        function syncUser(nick) {
            db.ref('users').child(nick).on('value', s => {
                const data = s.val() || {};
                myCoins = data.coins || 0;
                document.getElementById('balance-val').innerText = myCoins;
                
                const itemsDiv = document.getElementById('my-items');
                if(data.inventory) {
                    itemsDiv.innerHTML = Object.values(data.inventory).join("<br>‚Ä¢ ");
                }
            });
            db.ref('banned').child(nick).on('value', s => {
                document.getElementById('errScr').style.display = s.exists() ? 'flex' : 'none';
            });
        }

        function startSession() {
            const n = document.getElementById('user-login').value.trim();
            if(n.length < 2) return;
            myNick = n; localStorage.setItem('ghost_user', n);
            document.getElementById('reg-screen').style.display = 'none';
            syncUser(n);
        }
        if(myNick) { syncUser(myNick); document.getElementById('reg-screen').style.display = 'none'; }

        // –ì–û–õ–û–í–ù–ê –õ–û–ì–Ü–ö–ê –ö–ê–†–¢–û–ö
        db.ref('posts').on('value', snapshot => {
            const feed = document.getElementById('main-feed');
            feed.innerHTML = "";
            const adminList = document.getElementById('admin-list');
            adminList.innerHTML = "<h4>–ö–µ—Ä—É–≤–∞–Ω–Ω—è:</h4>";

            snapshot.forEach(child => {
                const d = child.val();
                const id = child.key;
                const price = parseInt(d.price) || 0;

                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –ø–æ–∫—É–ø–∫–∏
                db.ref('users').child(myNick).child('inventory').child(id).once('value', bought => {
                    const isOwner = d.nick === myNick;
                    const isBought = bought.exists() || isOwner;
                    
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `
                        <div class="price-tag">üí∞ ${price}</div>
                        <img src="${d.img}" class="item-img" onerror="this.src='https://via.placeholder.com/230x130?text=No+Photo'">
                        <div class="item-info ${!isBought ? 'locked-blur' : ''}">
                            <b>${d.title}</b><br>
                            <p style="font-size:12px; margin-top:5px;">${isBought ? d.desc : 'üîí –ö—É–ø—ñ—Ç—å, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –æ–ø–∏—Å'}</p>
                            <span style="color:var(--accent); font-size:11px;">–ê–≤—Ç–æ—Ä: @${d.nick}</span>
                        </div>
                        ${!isBought ? `
                            <div class="buy-btn-container">
                                <button class="btn-buy" onclick="buyItem('${id}', ${price}, '${d.title}', '${d.nick}')">üõí –ö–£–ü–ò–¢–ò –ó–ê ${price}</button>
                            </div>
                        ` : `
                            <div style="text-align:center; padding:10px; color:var(--gold); font-size:12px; font-weight:bold;">‚úÖ –í–Ü–î–ö–†–ò–¢–û</div>
                        `}
                    `;
                    feed.appendChild(card);

                    adminList.innerHTML += `<div style="background:#222; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between;">
                        <span>${d.title} (@${d.nick})</span>
                        <button onclick="db.ref('posts').child('${id}').remove()" style="background:red;">DEL</button>
                    </div>`;
                });
            });
        });

        function buyItem(id, price, title, owner) {
            if(myCoins < price) {
                alert(`‚ùå –¢–æ–±—ñ —Ç—Ä–µ–±–∞ —â–µ ${price - myCoins}üí∞! –ü–∏—à–∏ –≤ —á–∞—Ç.`);
                return;
            }
            if(confirm(`–ö—É–ø–∏—Ç–∏ "${title}" –∑–∞ ${price}üí∞?`)) {
                // –ó–Ω—ñ–º–∞—î–º–æ —É –ø–æ–∫—É–ø—Ü—è
                db.ref('users').child(myNick).child('coins').set(myCoins - price);
                // –î–æ–¥–∞—î–º–æ –≤ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä
                db.ref('users').child(myNick).child('inventory').child(id).set(title);
                // –í—ñ–¥–¥–∞—î–º–æ –≥—Ä–æ—à—ñ –ø—Ä–æ–¥–∞–≤—Ü—é! (—è–∫ —É —Å–ø—Ä–∞–≤–∂–Ω—ñ–π –µ–∫–æ–Ω–æ–º—Ü—ñ)
                db.ref('users').child(owner).child('coins').once('value', s => {
                    const ownerCoins = s.val() || 0;
                    db.ref('users').child(owner).child('coins').set(ownerCoins + price);
                });
                alert("üéâ –£—Å–ø—ñ—à–Ω–æ! –û–ø–∏—Å —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ.");
            }
        }

        function publish() {
            const t = document.getElementById('f-title').value;
            const p = document.getElementById('f-price').value;
            if(!t || !p) return;
            db.ref('posts').push({
                nick: myNick,
                title: t,
                img: document.getElementById('f-img').value,
                price: p,
                desc: document.getElementById('f-desc').value
            });
            document.getElementById('addModal').style.display = 'none';
        }

        function sendChat(e) {
            if(e.key === 'Enter' && e.target.value.trim() !== "") {
                db.ref('chat').push({ user: myNick, text: e.target.value });
                db.ref('users').child(myNick).child('coins').set(myCoins + 10);
                e.target.value = "";
            }
        }

        function createPromo() {
            const c = document.getElementById('p-code').value.toUpperCase();
            const a = parseInt(document.getElementById('p-amount').value);
            if(c && a) db.ref('promos').child(c).set(a);
        }

        function usePromo() {
            const c = prompt("–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥:").toUpperCase();
            db.ref('promos').child(c).once('value', s => {
                if(s.exists()) {
                    db.ref('users').child(myNick).child('coins').set(myCoins + s.val());
                    db.ref('promos').child(c).remove();
                    alert(`–ë–æ–Ω—É—Å +${s.val()}üí∞!`);
                } else alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–æ–¥.");
            });
        }

        function openAdmin() { if(prompt("Pass:") === "loldemid509") document.getElementById('admin-panel').style.display = 'block'; }
        db.ref('chat').limitToLast(15).on('child_added', s => {
            const cb = document.getElementById('chat-box');
            cb.innerHTML += `<div><b>${s.val().user}:</b> ${s.val().text}</div>`;
            cb.scrollTop = cb.scrollHeight;
        });
    </script>
</body>
</html>
